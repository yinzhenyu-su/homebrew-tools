name: Test Release Process

on:
  workflow_dispatch:
    inputs:
      test_version:
        description: 'Test version (e.g., 1.0.0-test)'
        required: true
        default: '1.0.0-test'

jobs:
  test-release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run quick tests
        run: |
          chmod +x ./tests/test-quick.sh
          ./tests/test-quick.sh

      - name: Test Formula syntax
        run: |
          ruby -c Formula/switch-claude.rb

      - name: Test script functionality
        run: |
          chmod +x ./scripts/switch-claude.sh
          ./scripts/switch-claude.sh help
          ./scripts/switch-claude.sh current || true
          ./scripts/switch-claude.sh show-tokens

      - name: Simulate SHA256 calculation
        run: |
          VERSION="${{ github.event.inputs.test_version }}"
          echo "Testing with version: $VERSION"
          
          # æ¨¡æ‹Ÿä¸‹è½½å’ŒSHA256è®¡ç®—è¿‡ç¨‹
          echo "æ¨¡æ‹Ÿåˆ›å»ºtarball..."
          tar -czf "/tmp/test-${VERSION}.tar.gz" --exclude='.git' .
          
          # è®¡ç®—SHA256
          SHA256=$(sha256sum "/tmp/test-${VERSION}.tar.gz" | cut -d ' ' -f 1)
          echo "è®¡ç®—å¾—åˆ°çš„SHA256: $SHA256"
          
          # éªŒè¯SHA256æ ¼å¼
          if [[ ${#SHA256} -eq 64 ]]; then
            echo "âœ… SHA256æ ¼å¼æ­£ç¡®"
          else
            echo "âŒ SHA256æ ¼å¼é”™è¯¯"
            exit 1
          fi

      - name: Test version release script
        run: |
          chmod +x ./scripts/release.sh
          ./scripts/release.sh current
          
          # æµ‹è¯•ç‰ˆæœ¬éªŒè¯åŠŸèƒ½
          if ./scripts/release.sh help | grep -q "ç‰ˆæœ¬å‘å¸ƒè„šæœ¬"; then
            echo "âœ… å‘å¸ƒè„šæœ¬æ­£å¸¸"
          else
            echo "âŒ å‘å¸ƒè„šæœ¬å¼‚å¸¸"
            exit 1
          fi

      - name: Summary
        run: |
          echo "ğŸ‰ å‘å¸ƒæµç¨‹æµ‹è¯•å®Œæˆï¼"
          echo ""
          echo "âœ… å·²éªŒè¯çš„ç»„ä»¶ï¼š"
          echo "- è„šæœ¬è¯­æ³•å’ŒåŠŸèƒ½"
          echo "- Formulaè¯­æ³•"
          echo "- å‘å¸ƒè„šæœ¬"
          echo "- SHA256è®¡ç®—é€»è¾‘"
          echo ""
          echo "ğŸš€ å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥è¿›è¡Œæ­£å¼å‘å¸ƒï¼"