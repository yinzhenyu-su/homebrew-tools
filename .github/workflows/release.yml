name: Release and Update Formula

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.1.0)'
        required: true
        type: string

env:
  HOMEBREW_NO_INSTALL_FROM_API: 1

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    outputs:
      tag_name: ${{ steps.tag.outputs.tag_name }}
      version: ${{ steps.tag.outputs.version }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Determine version and tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG_NAME="v${VERSION}"
          else
            TAG_NAME="${{ github.ref_name }}"
            VERSION="${TAG_NAME#v}"
          fi
          
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Tag: ${TAG_NAME}, Version: ${VERSION}"

      - name: Create or update tag
        run: |
          TAG_NAME="${{ steps.tag.outputs.tag_name }}"
          if ! git tag -l | grep -q "^${TAG_NAME}$"; then
            git tag "${TAG_NAME}"
            git push origin "${TAG_NAME}"
          fi

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -2 | tail -1)
          if [[ -z "$PREVIOUS_TAG" ]]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "## ğŸš€ What's New in ${{ steps.tag.outputs.version }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          
          # æå– commit ä¿¡æ¯
          git log --pretty=format:"- %s" "${PREVIOUS_TAG}..${{ steps.tag.outputs.tag_name }}" | head -20 >> $GITHUB_OUTPUT
          
          echo "" >> $GITHUB_OUTPUT
          echo "## ğŸ“‹ Installation" >> $GITHUB_OUTPUT
          echo '```bash' >> $GITHUB_OUTPUT
          echo 'brew tap yinzhenyu-su/homebrew-tools' >> $GITHUB_OUTPUT
          echo 'brew install switch-claude' >> $GITHUB_OUTPUT
          echo '```' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          release_name: "Switch Claude ${{ steps.tag.outputs.version }}"
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          draft: false
          prerelease: false

  update-formula:
    needs: release
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Git for Homebrew
        uses: Homebrew/actions/git-user-config@main

      - name: Install dependencies
        run: |
          brew install jq

      - name: Download and calculate SHA256
        id: sha256
        run: |
          TAG_NAME="${{ needs.release.outputs.tag_name }}"
          VERSION="${{ needs.release.outputs.version }}"
          
          # ä¸‹è½½ tarball
          TARBALL_URL="https://github.com/${{ github.repository }}/archive/${TAG_NAME}.tar.gz"
          echo "ä¸‹è½½ tarball: ${TARBALL_URL}"
          
          curl -L -o "/tmp/release.tar.gz" "${TARBALL_URL}"
          
          # è®¡ç®— SHA256
          if [[ "$OSTYPE" == "darwin"* ]]; then
            SHA256=$(shasum -a 256 "/tmp/release.tar.gz" | cut -d ' ' -f 1)
          else
            SHA256=$(sha256sum "/tmp/release.tar.gz" | cut -d ' ' -f 1)
          fi
          
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "tarball_url=${TARBALL_URL}" >> $GITHUB_OUTPUT
          echo "Calculated SHA256: ${SHA256}"
          echo "Tarball URL: ${TARBALL_URL}"

      - name: Update Formula
        id: update_formula
        run: |
          TAG_NAME="${{ needs.release.outputs.tag_name }}"
          VERSION="${{ needs.release.outputs.version }}"
          SHA256="${{ steps.sha256.outputs.sha256 }}"
          TARBALL_URL="${{ steps.sha256.outputs.tarball_url }}"
          
          # å¤‡ä»½åŸæ–‡ä»¶
          cp Formula/switch-claude.rb Formula/switch-claude.rb.backup
          
          # æ›´æ–° Formula æ–‡ä»¶
          cat > Formula/switch-claude.rb << EOF
          class SwitchClaude < Formula
            desc "Claude Code æ¨¡å‹åˆ‡æ¢å·¥å…·"
            homepage "https://github.com/${{ github.repository }}"
            url "${TARBALL_URL}"
            version "${VERSION}"
            sha256 "${SHA256}"
            license "MIT"
          
            depends_on "jq"
          
            def install
              # å®‰è£…è„šæœ¬åˆ° bin ç›®å½•
              bin.install "scripts/switch-claude.sh" => "switch-claude"
          
              # åˆ›å»ºç¬¦å·é“¾æ¥ä»¥æ”¯æŒå¸¸ç”¨åˆ«å
              bin.install_symlink "switch-claude" => "claude-switch"
              bin.install_symlink "switch-claude" => "sc"
            end
          
            def caveats
              <<~EOS
                Claude Code æ¨¡å‹åˆ‡æ¢å·¥å…·å·²å®‰è£…æˆåŠŸï¼
          
                ä½¿ç”¨æ–¹æ³•ï¼š
                  switch-claude glm                    # åˆ‡æ¢åˆ° GLM æ¨¡å‹
                  switch-claude kimi                   # åˆ‡æ¢åˆ° Kimi æ¨¡å‹
                  switch-claude minimax                # åˆ‡æ¢åˆ° Minimax æ¨¡å‹
                  switch-claude current                # æ˜¾ç¤ºå½“å‰é…ç½®
                  switch-claude clear                  # æ¸…ç©ºé…ç½®
                  switch-claude help                   # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
          
                é«˜çº§ç”¨æ³•ï¼š
                  switch-claude glm --launch           # åˆ‡æ¢å¹¶å¯åŠ¨ Claude Code
                  switch-claude kimi --launch ä½ å¥½     # åˆ‡æ¢å¹¶å‘é€æ¶ˆæ¯
          
                Token ç®¡ç†ï¼š
                  switch-claude set-token <provider> <token>        # å­˜å‚¨åˆ°æ–‡ä»¶
                  switch-claude set-keychain <provider> <token>     # å­˜å‚¨åˆ° Keychain (æ¨è)
                  switch-claude show-tokens                         # æ˜¾ç¤º token çŠ¶æ€
          
                åˆ«åå‘½ä»¤ï¼š
                  claude-switch  # ç­‰åŒäº switch-claude
                  sc            # ç­‰åŒäº switch-claude
          
                é…ç½®æ–‡ä»¶ä½ç½®: ~/.claude/settings.json
                Token é…ç½®ç›®å½•: ~/.config/switch-claude/
          
                æ³¨æ„ï¼šæ­¤å·¥å…·éœ€è¦æ‚¨å·²ç»å®‰è£…äº† Claude Codeã€‚
              EOS
            end
          
            test do
              # æµ‹è¯•å¸®åŠ©å‘½ä»¤
              system "#{bin}/switch-claude", "help"
          
              # æµ‹è¯•ä¾èµ–æ£€æŸ¥
              assert_predicate bin/"switch-claude", :exist?
              assert_predicate bin/"claude-switch", :exist?
              assert_predicate bin/"sc", :exist?
            end
          end
          EOF
          
          echo "Formula å·²æ›´æ–°:"
          echo "  ç‰ˆæœ¬: ${VERSION}"
          echo "  SHA256: ${SHA256}"
          echo "  URL: ${TARBALL_URL}"

      - name: Test Formula
        run: |
          # æµ‹è¯• Formula è¯­æ³•
          brew audit --strict --online Formula/switch-claude.rb || true
          
          # å°è¯•å®‰è£…æµ‹è¯•ï¼ˆdry runï¼‰
          brew install --build-from-source --verbose Formula/switch-claude.rb || true

      - name: Commit and push changes
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          
          git add Formula/switch-claude.rb
          
          if ! git diff --staged --quiet; then
            git commit -m "chore: update switch-claude to v${VERSION}
            
            - Update version to ${VERSION}
            - Update SHA256 hash
            - Update download URL
            
            Auto-generated by GitHub Actions"
            
            git push origin main
            echo "âœ… Formula æ›´æ–°å·²æäº¤å¹¶æ¨é€"
          else
            echo "â„¹ï¸  æ— å˜æ›´éœ€è¦æäº¤"
          fi

  notify:
    needs: [release, update-formula]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify completion
        run: |
          if [[ "${{ needs.update-formula.result }}" == "success" ]]; then
            echo "ğŸ‰ å‘å¸ƒæˆåŠŸå®Œæˆï¼"
            echo "ğŸ“¦ ç‰ˆæœ¬: ${{ needs.release.outputs.version }}"
            echo "ğŸ·ï¸  æ ‡ç­¾: ${{ needs.release.outputs.tag_name }}"
            echo "ğŸ“¥ å®‰è£…å‘½ä»¤:"
            echo "   brew tap yinzhenyu-su/homebrew-tools"
            echo "   brew install switch-claude"
          else
            echo "âŒ å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯"
            exit 1
          fi